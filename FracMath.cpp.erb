#include "Config.h"
#include "Norm.h"
#include "Methods.hpp"
#include "TypeHelpers.hpp"
#include "Types.h"

#include <iostream>
#include <utility>
#include <vector>

#include <cassert>
#include <cmath>

auto getFractal() -> std::vector<PtColor> {
  std::vector<PtColor> ColorIdxs;
  ColorIdxs.reserve(XLen * YLen);

  static auto Fn = [](ValType Pt) -> ValType {
    <%= expr %>
  };
  static auto Norm = [](ValType Pt) {
    return norm2(Pt);
  };
  static auto ColorFn = [](ValType Pt) -> double {
    return std::arg(Pt);
  };

  using Method = CalcNext<%= method %><decltype(Fn), decltype(Norm)>;

  for (int i = MinX; i < MaxX; ++i) {
    FloatType X = static_cast<FloatType>(i) / Scale + CX;
    for (int j = MinY; j < MaxY; ++j) {
      FloatType Y = static_cast<FloatType>(j) / Scale + CY;
      ValType Init = ValType(X, Y);
      PtColor Val =
        getPointIndexN<Method, decltype(ColorFn)>(Fn, Norm, ColorFn, Init);
      ColorIdxs.push_back(Val);
    }
    std::cerr << '.';
  }
  std::cerr << '\n';

  return ColorIdxs;
}
