#include "Color.h"
#include "Config.h"
#include "Norm.h"
#include "Methods.hpp"
#include "TypeHelpers.hpp"
#include "Types.h"

#include <iostream>
#include <utility>
#include <vector>

#include <cassert>
#include <cmath>
#include <cstdlib>

auto getFractal() -> std::vector<PtColor> {
  std::vector<PtColor> ColorIdxs;
  ColorIdxs.reserve(XLen * YLen);

  struct Func {
    ValType operator()(ValType Pt) {
      static auto Fn = [](ValType Pt) -> ValType {
        <%= expr %>
      };
      return Fn(Pt);
    }

    static ValType diff(ValType Pt) {
      static auto FnDiff = [](ValType Pt) -> ValType {
        <%= expr_diff %>
      };
      return FnDiff(Pt);
    }
  };

  static auto Norm = [](ValType Pt) {
    return norm1(Pt);
  };
  static auto ColorFn = [](ValType Pt, int Iters) {
    return PointColor(Pt, Iters);
  };

  using Method = CalcNext<%= method %><%= method_params %>;

  for (int i = MinX; i < MaxX; ++i) {
    FloatType X = static_cast<FloatType>(i) / Scale + CX;
    for (int j = MinY; j < MaxY; ++j) {
      FloatType Y = static_cast<FloatType>(j) / Scale + CY;
      ColorIdxs.emplace_back(getPointIndexN<Method>(Func(), Norm, ColorFn, ValType(X, Y)));
    }
    std::cerr << '.';
  }
  std::cerr << '\n';

  return ColorIdxs;
}
